<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <title>Stoppelrennen Dobberzin 2025</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --green:#C6EFCE;--greenText:#006100;
            --red:#FFC7CE;  --redText:#9C0006;
            --gold:#FFD966; --silver:#D9D9D9;--bronze:#F4B183;--final:#E2F0D9;
            --stickyTop:0px;                           /* Kopfzeile klebt ganz oben */
            --spinner-img:url('./images/car2.gif');    /* dein GIF */
            --spinner-size:130px;                      /* Bildgröße */
            --marquee-speed:20s;                       /* Standardgeschwindigkeit (wird per JS gesetzt) */
        }
        *{box-sizing:border-box;margin:0}
        body{font:400 16px/1.45 Roboto,Arial,sans-serif;background:#f7f7f7;color:#111}

        /* ---------- Spinner ---------- */
        #spinner{
            position:fixed;inset:0;display:flex;justify-content:center;align-items:center;
            background:rgba(255,255,255,.7);z-index:999}
        #spinner.hide{display:none}
        #spinner::after{
            content:"";width:var(--spinner-size);height:var(--spinner-size);
            background:var(--spinner-img) center/contain no-repeat;
        }

        /* ---------- Kopf & Sponsor ---------- */
        #masthead{position:sticky;top:0;z-index:10;background:#183028}
        header{background:#183028;color:#fff;text-align:center;padding:8px 16px}
        header img{height:80px;margin-right:8px;vertical-align:middle}

        #sponsors{overflow:hidden;background:#fff;border-block:2px solid #eee}
        #sponsors .track{
            display:flex; gap:64px; align-items:center;
            width:max-content;                 /* Breite = Contentbreite */
            animation:marquee var(--marquee-speed) linear infinite;
            will-change:transform;
            padding:4px 0;
        }
        /* Jede Logo-Kachel fix 140×80, Bild proportional via object-fit */
        #sponsors .logo{
            width:140px; height:80px; flex:0 0 auto;
            display:flex; align-items:center; justify-content:center;
        }
        #sponsors .logo img{
            width:100%; height:100%; object-fit:contain; display:block;
        }

        @keyframes marquee{
            from { transform:translateX(0); }
            to   { transform:translateX(-50%); }  /* nur bis zur Hälfte (weil doppelt gerendert) */
        }

        /* ---------- Tabs ---------- */
        nav{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:16px auto}
        nav button{padding:8px 16px;border:1px solid #ccc;border-radius:4px;background:#fff;font-weight:700;cursor:pointer}
        nav button.active{background:#183028;color:#fff;border-color:#183028}
        .hidden{display:none !important}

        /* ---------- Tabellen ---------- */
        .section{display:none;max-width:1000px;margin:0 auto;padding:0 8px 48px}
        .section.active{display:block}
        .tableWrap{overflow-x:auto}
        table{width:100%;border-collapse:collapse;margin-top:8px;font-size:clamp(14px,2.5vw,16px)}
        thead th{background:#e0e0e0;position:sticky;top:var(--stickyTop);text-align:left}
        td,th{padding:4px 8px;border-bottom:1px solid #ddd;white-space:nowrap;text-overflow:ellipsis}
        tbody tr:nth-child(even){background:#fafafa}

        .badge{display:inline-block;padding:2px 6px;border-radius:4px;font-weight:700;font-size:.8em}
        .badge.q{background:var(--green);color:var(--greenText)}
        .badge.out{background:var(--red);color:var(--redText)}
        .badge.gold{background:var(--gold)}.badge.silver{background:var(--silver)}
        .badge.bronze{background:var(--bronze)}.badge.final{background:var(--final)}

        .updated{text-align:center;font-size:12px;color:#666;margin-top:6px}

        /* Optional: Bewegungen für Nutzer reduzieren */
        @media (prefers-reduced-motion: reduce){
            #sponsors .track{ animation-duration: calc(2 * var(--marquee-speed)); }
        }
    </style>
</head>
<body>
<!-- Spinner -->
<div id="spinner" class="hide"></div>

<!-- Kopfbereich -->
<div id="masthead">
    <header>
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSh2xaOaoQRipR8bA5GghETop505AnzMnHSQQ&s" alt="">
        Stoppelrennen Dobberzin 2025
        LIVETICKER
    </header>
    <div id="sponsors"><div class="track" id="sponsorTrack"></div></div>
</div>

<!-- Tabs -->
<nav id="tabs">
    <button data-tab="leader" class="active">Vorrunde</button>
    <!-- KO-Tabs initial versteckt, um Flackern zu vermeiden -->
    <button data-tab="vf"  class="hidden">Viertelfinale</button>
    <button data-tab="hf"  class="hidden">Halbfinale</button>
    <button data-tab="fin" class="hidden">Finale</button>
</nav>

<!-- Tabellen -->
<div id="leader" class="section active">
    <div class="tableWrap"><table id="tbl-leader"><thead></thead><tbody></tbody></table></div>
    <div class="updated" id="upd-leader"></div>
</div>
<div id="vf" class="section hidden">
    <div class="tableWrap"><table id="tbl-vf"><thead></thead><tbody></tbody></table></div>
    <div class="updated" id="upd-vf"></div>
</div>
<div id="hf" class="section hidden">
    <div class="tableWrap"><table id="tbl-hf"><thead></thead><tbody></tbody></table></div>
    <div class="updated" id="upd-hf"></div>
</div>
<div id="fin" class="section hidden">
    <div class="tableWrap"><table id="tbl-fin"><thead></thead><tbody></tbody></table></div>
    <div class="updated" id="upd-fin"></div>
</div>

<script>
  const CFG={
    // Ergebnisdaten kommen ausschließlich vom Apps Script:
    api:'https://script.google.com/macros/s/AKfycbybETY44dfDCMMgN_c96hr3imGkGaB9b0w72_cLkIfNRWAtNsjVPPQfgxfPvORHzDi4bw/exec',
    refresh:120000,
    sponsors:[
      {n:'Agrar Dobberzin', l:'./images/logos/Agrar_Dobberzin.jpg', href:''},
      {n:'MGQ', l:'./images/logos/MGQ_Logo.png', href:'https://mgq.solutions'},
      {n:'Brune', l:'./images/logos/ArbeitsUndBrandschutzserviceBrune.png', href:'https://mgq.solutions'},
      {n:'W&G', l:'./images/logos/W_G.jpg', href:''},
      {n:'Baufa', l:'./images/logos/Baufa.jpg', href:'https://www.baufa-nord-ost.de'},
      {n:'Müller', l:'./images/logos/Bauschlosserei_Mueller.jpg', href:'https://www.bauschlosserei-mueller.com'},
      {n:'Bergmann', l:'./images/logos/Bergmann.jpg', href:'https://www.theodor-bergmann.de'},
      {n:'Dersin', l:'./images/logos/Dersin.png', href:'https://dach-dersin.de'},
      {n:'Döhring', l:'./images/logos/Doehring.jpg', href:'https://autowerkstatt-angermünde.de/#pano=1'},
      {n:'ESF', l:'./images/logos/ESF.jpeg', href:'http://esfrommann.de'},
      {n:'Fliesen Mike', l:'./images/logos/Fliesen_Mike.jpg', href:''},
      {n:'Hilges', l:'./images/logos/Hilges.png', href:'https://kfzhilges.de'},
      {n:'HTH Steinke', l:'./images/logos/HTH_Steinke.png', href:'https://hth-steinke.de'},
      {n:'Kauk', l:'./images/logos/KlempnerKauk.jpg', href:'https://klempner-kauk.de'},
      {n:'Küchenbär', l:'./images/logos/Kuechenbaer.png', href:'https://derkuechenbaer.de'},
      {n:'Möbelbär', l:'./images/logos/Moebelbaer.png', href:'https://derkuechenbaer.de'},
      {n:'Lunower Landfleischerei', l:'./images/logos/Lunower_Landfleischerei.png', href:'https://fleischerei-kuenkel.de'},
      {n:'MB', l:'./images/logos/MB_Dienstleistungen.png', href:''},
      {n:'MTJordan', l:'./images/logos/MTJordan.jpg', href:'https://www.facebook.com/p/MTJ-Maschinen-Technik-Jordan-61571312750107/'},
      {n:'Reifenserive Schulz', l:'./images/logos/Reifenservice_Schulz.jpg', href:'http://www.reifen-und-batterieservice.de'},
      {n:'Riepert', l:'./images/logos/riepert.jpg', href:'https://galabau-riepert.de'},
      {n:'Rössler', l:'./images/logos/Roessler.png', href:'https://www.getraenke-roessler.de'},
      {n:'Schäfer', l:'./images/logos/', href:'https://tp-schaefer.de'},
      {n:'T&G', l:'./images/logos/T_G.jpg', href:'https://www.tundg-lkw.de'},
      {n:'TUB', l:'./images/logos/TUB.jpg', href:'https://www.tub-technik.de/de/start'},
      {n:'W&G', l:'./images/logos/W_G.jpg', href:'https://www.facebook.com/p/W-G-Fahrzeugtechnik-100063635379274/?locale=de_DE'},
      {n:'Wrensch', l:'./images/logos/Wrensch.jpg', href:'https://containershop-wrensch.de'},
      //{n:'', l:'./images/logos/', href:''},
    ],
    // Nur für den Sichtbarkeits-Check (Rennübersicht!D2:E193)
    sheetId:'1gerTSMPMCxL1VqUBMRoi77LoLSpQ5hPoOYMO1UmqnaM',
    gidRennuebersicht:'1394865267',
    rowStart:2,
    rowEnd:193
  };

  // Sponsoren-Laufband (nahtlos: Inhalt exakt doppelt + Animation bis -50 %)
  (function buildMarquee(){
    const items = CFG.sponsors.map(s => `
      <a class="logo" href="${s.href || '#'}" target="_blank" rel="noopener">
        <img src="${s.l}" alt="${s.n}" loading="lazy" decoding="async">
      </a>`).join('');
    document.getElementById('sponsorTrack').innerHTML = items + items;

    // Geschwindigkeit dynamisch an Menge koppeln (≈ 3 s pro Sponsor, mind. 12 s)
    const speedSec = Math.max(12, CFG.sponsors.length * 3);
    document.documentElement.style.setProperty('--marquee-speed', `${speedSec}s`);
  })();

  const q=v=>v==='✓'?'<span class="badge q">✓</span>':v==='✗'?'<span class="badge out">✗</span>':'';
  const p=x=>{const n=+x;return n===1?'<span class="badge gold">1</span>':n===2?'<span class="badge silver">2</span>':n===3?'<span class="badge bronze">3</span>':n?`<span class="badge final">${n}</span>`:'';};

  const spin=on=>document.getElementById('spinner').classList.toggle('hide',!on);

  // Tabellen befüllen
  function fill(id,data,head,rowFn){
    const {v,bg}=data, tbl=document.getElementById(id);
    tbl.querySelector('thead').innerHTML='<tr>'+head.map(h=>`<th>${h}</th>`).join('')+'</tr>';
    tbl.querySelector('tbody').innerHTML = v.slice(1) // skip header
      .filter(r=>!r.every(c=>c===''||c===null))       // skip komplett leere Zeilen
      .map((r,i)=>rowFn(r,(bg[i+1]||[''])))           // fallback, falls bg fehlt
      .join('');
  }
  const rowLeader=(r,c)=>`<tr style="background:${c[0]}"><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td></tr>`;
  const rowPhase =(r,c)=>`<tr style="background:${c[0]}"><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${q(r[5])}</td></tr>`;
  const rowFin   =(r,c)=>`<tr style="background:${c[0]}"><td>${p(r[4])}</td><td>${r[2]}</td><td>${r[3]}</td></tr>`;

  // Tabs/Sektionen referenzieren
  const btn = {
    leader: document.querySelector('button[data-tab="leader"]'),
    vf:     document.querySelector('button[data-tab="vf"]'),
    hf:     document.querySelector('button[data-tab="hf"]'),
    fin:    document.querySelector('button[data-tab="fin"]')
  };
  const sec = {
    leader: document.getElementById('leader'),
    vf:     document.getElementById('vf'),
    hf:     document.getElementById('hf'),
    fin:    document.getElementById('fin')
  };

  function currentActiveTab(){
    return document.querySelector('#tabs button.active')?.dataset.tab || 'leader';
  }
  function showTab(id){
    Object.keys(btn).forEach(k=>{
      btn[k].classList.toggle('active',k===id && !btn[k].classList.contains('hidden'));
      sec[k].classList.toggle('active',k===id);
    });
  }

  // === Vorrunden-Check (flexibel): aktive Zeilen = D befüllt; für alle aktiven muss E befüllt sein ===
  async function isVorrundeComplete(){
    const range = `D${CFG.rowStart}:E${CFG.rowEnd}`;
    const url = `https://docs.google.com/spreadsheets/d/${CFG.sheetId}/gviz/tq`
      + `?gid=${CFG.gidRennuebersicht}`
      + `&range=${encodeURIComponent(range)}`
      + `&tq=${encodeURIComponent('select D,E')}&tqx=out:json`;
    try{
      const txt = await (await fetch(url,{cache:'no-store'})).text();
      const m = txt.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);?$/);
      if(!m) { console.warn('gviz response parse fail'); return false; }
      const payload = JSON.parse(m[1]);
      const rows = payload.table?.rows || [];

      let active = 0, withE = 0;
      rows.forEach((r, idx) => {
        const d = r.c?.[0]?.v;  // Fahrer (D)
        const e = r.c?.[1]?.v;  // Punkte (E)
        const hasD = d != null && String(d).trim() !== '';
        if(hasD){
          active++;
          const hasE = e != null && String(e).trim() !== '';
          if(hasE){ withE++; }
          else { console.log(`Vorrunde offen: D${CFG.rowStart+idx}="${d}" hat noch keine Punkte in E${CFG.rowStart+idx}`); }
        }
      });

      const ok = active>0 && withE===active;
      console.log(`[Vorrunde] aktive=${active}, mit Punkten=${withE} -> ${ok?'OK':'NICHT OK'}`);
      return ok;
    }catch(e){
      console.warn('Fehler beim gviz-Check D/E', e);
      return false; // failsafe: Tabs ausgeblendet
    }
  }

  // KO-Tabs gemeinsam ein/ausblenden
  function setKoVisibility(show){
    ['vf','hf','fin'].forEach(k=>{
      btn[k].classList.toggle('hidden', !show);
      sec[k].classList.toggle('hidden', !show);
    });
    const active=currentActiveTab();
    if((active==='vf'||active==='hf'||active==='fin') && !show){
      showTab('leader');
    }
  }

  async function load(){
    spin(true);
    try{
      // Tabellen (Apps Script) + Vorrunden-Check parallel holen
      const [d, vorrundeOK] = await Promise.all([
        fetch(CFG.api+'?t='+Date.now(), {cache:'no-store'}).then(r=>r.json()),
        isVorrundeComplete()
      ]);

      // Tabellen befüllen (rein aus Apps Script)
      fill('tbl-leader',d.leader,['Platz','Startnummer','Fahrer','Punkte'],rowLeader);
      fill('tbl-vf',    d.vf,    ['Rennen','Startnummer','Fahrer','Qualifiziert'],rowPhase);
      fill('tbl-hf',    d.hf,    ['Rennen','Startnummer','Fahrer','Qualifiziert'],rowPhase);
      fill('tbl-fin',   d.fin,   ['Endplatzierung','Startnummer','Fahrer'],rowFin);

      // KO-Sichtbarkeit ausschließlich über den Vorrunden-Check
      setKoVisibility(vorrundeOK);

      const ts=new Date().toLocaleTimeString('de-DE',{hour12:false});
      ['leader','vf','hf','fin'].forEach(i=>{
        const el=document.getElementById('upd-'+i);
        if(el) el.textContent='Aktualisiert: '+ts;
      });
    }catch(e){
      console.error(e);
      setKoVisibility(false);
    }
    spin(false);
  }

  load();
  setInterval(load, CFG.refresh);

  // Tabs: versteckte ignorieren
  document.querySelectorAll('#tabs button').forEach(b=>{
    b.onclick=()=>{
      if(b.classList.contains('hidden')) return;
      document.querySelectorAll('#tabs button').forEach(x=>x.classList.toggle('active',x===b));
      document.querySelectorAll('.section').forEach(s=>s.classList.toggle('active',s.id===b.dataset.tab));
    };
  });
</script>
</body>
</html>